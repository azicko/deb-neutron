#!/bin/sh

set -e

. /usr/share/debconf/confmodule

N_CONF=/etc/neutron/neutron.conf
OVS_CONF=/etc/neutron/plugins/openvswitch/ovs_neutron_plugin.ini

#PKGOS-INCLUDE#

pkgos_var_user_group neutron
chmod 755 /var/lib/neutron

# Configure the SQL connection
pkgos_dbc_read_conf -pkg neutron-common ${OVS_CONF} DATABASE connection neutron $@

# Configure the keystone_authtoken
pkgos_read_admin_creds ${N_CONF} keystone_authtoken neutron

# Select which plugin to use
pkgos_read_config -p high /etc/default/neutron-server NO_SECTION NEUTRON_plugin_path neutron/plugin-select

# OVS specific configurations (if that's the one selected)
if [ "${RET}" = "OpenVSwitch" ] ; then
	# Various network config...
	pkgos_read_config ${OVS_CONF} OVS tenant_network_type   neutron-plugin-openvswitch/tenant_network_type
	pkgos_read_config ${OVS_CONF} OVS enable_tunneling      neutron-plugin-openvswitch/enable_tunneling
	pkgos_read_config ${OVS_CONF} OVS tunnel_id_ranges      neutron-plugin-openvswitch/tunnel_id_ranges

	# Guess values to put in the local_ip directive
	IF=`LC_ALL=C route | grep default |awk -- '{ print $8 }'`
	guessed_ip_addr=`LC_ALL=C ifconfig ${IF} | grep 'inet addr' | sed 's/.\+inet addr:\([0-9.]\+\).\+/\1/'`
	if [ -z "${guessed_ip_addr}" ] ; then
		guessed_ip_addr=`LC_ALL=C ifconfig ${IF} | grep 'inet adr' | sed 's/.\+inet adr:\([0-9.]\+\).\+/\1/'`
	fi
	db_set neutron-plugin-openvswitch/local_ip ${guessed_ip_addr}
	pkgos_read_config ${OVS_CONF} OVS local_ip neutron-plugin-openvswitch/local_ip
fi

exit 0
