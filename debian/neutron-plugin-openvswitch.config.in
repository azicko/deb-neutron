#!/bin/sh

set -e

. /usr/share/debconf/confmodule

OVS_CONF=/etc/neutron/plugins/openvswitch/ovs_neutron_plugin.ini

#PKGOS-INCLUDE#

# Various network config...
pkgos_read_config ${OVS_CONF} OVS tenant_network_type	neutron-plugin-openvswitch/tenant_network_type
pkgos_read_config ${OVS_CONF} OVS enable_tunneling	neutron-plugin-openvswitch/enable_tunneling
pkgos_read_config ${OVS_CONF} OVS tunnel_id_ranges	neutron-plugin-openvswitch/tunnel_id_ranges

# Guess values to put in the local_ip directive
IF=`LC_ALL=C route | grep default |awk -- '{ print $8 }'`
guessed_ip_addr=`LC_ALL=C ifconfig ${IF} | grep 'inet addr' | sed 's/.\+inet addr:\([0-9.]\+\).\+/\1/'`
if [ -z "${guessed_ip_addr}" ] ; then
	guessed_ip_addr=`LC_ALL=C ifconfig ${IF} | grep 'inet adr' | sed 's/.\+inet adr:\([0-9.]\+\).\+/\1/'`
fi
db_set neutron-plugin-openvswitch/local_ip ${guessed_ip_addr}
pkgos_read_config ${OVS_CONF} OVS local_ip neutron-plugin-openvswitch/local_ip

# Configure the SQL connection
pkgos_dbc_read_conf -pkg neutron-plugin-openvswitch ${OVS_CONF} DATABASE sql_connection neutron-plugin-openvswitch $@

exit 0
